---
title: "SFB209 - Project Report"
subtitle: "Re-analysis of RNA-Seq data from mice of two experiments (QBiC projects  \nQPB205 and QRDGM) to detect DE genes and pathways in response to  \nDoxycyclin (Dox) treatment."
author: "Silvia Morini, Bioinformatics Research Scientist"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document:
    toc: true                               # table of contents
    toc_float: true                         # float the table of contents to the left of the main document content
    toc_depth: 3                            # header levels 1,2,3
    theme: default
    number_sections: true                   # add section numbering to headers
    df_print: paged                         # tables are printed as an html table with support for pagination over rows and columns
    css: corp-styles.css
    highlight: pygments
#   code_folding: none
#   theme: spacelab
    pdf_document: true
#   self_contained: no
bibliography: references.bibtex
---


<img src="logo.png" style="position:absolute;top:0px;right:0px;" height="200" width="200" />
<div class="watermark">QBiC</div>



```{r docSetup, bootstrap.show.code = FALSE, dev = 'png', bootstrap.show.message=FALSE, echo=FALSE, message=FALSE}
## knitrBoostrap and device chunk options
options(warn = -1)                          # suppress warnings and messages
library(knitr)
opts_chunk$set(bootstrap.show.code = FALSE, dev = 'png', echo=FALSE)

# the following is for writing image captions on their top
knit_hooks$set(plot = function(x, options) {
  paste('<figure><figcaption>', options$fig.cap, '</figcaption><img src="',
        opts_knit$get('base.url'), paste(x, collapse = '.'),
        '"></figure>',
        sep = '')
})
```

\
\
\
\

**Project Members:** 

***Steffie Revia***

AG Tschaharganeh - Cell Plasticity and Epigenetic Remodeling

UniversitätsKlinikum Heidelberg

Im Neuenheimer Feld 672

69120 Heidelberg, Germany

s.revia@dkfz-heidelberg.de

\
\
**QBiC contacts:**
***Dr. Alexander Peltzer***

alexander.peltzer@qbic.uni-tuebingen.de

Auf der Morgenstelle 10, 72076 Tuebingen

\
***Silvia Morini***

silvia.morini@qbic.uni-tuebingen.de

***

# Introduction and Aims
This project aims at the bioinformatics analysis of 12 RNA-Seq data sets derived from mice cells from two experiments (QBiC projects QPB205 and QRDGM), characterising the differential gene and pathway expression in response to Doxycyclin (Dox-on versus Dox-off). Of particular interest are the mTOR (and related) pathways, together with cell death and metabolic pathways. A standard Rna-seq analysis will be performed to find DE genes, and an enrichment analysis of the KEGG Pathways database will be carried out in order to investigate how the pathways of interest are affected by DE of genes.

***
<!--
# RNA Quality Assessment

Quality Assessment of the RNA samples by c.ATG can be found [here](./I19R008_Schindler_Project Report.pdf). The RNA Integrity Number (RIN) value for all the samples was above 9 (with 10 as maximum possible score), which indicates a very good overall RNA quality.

\
```{r}
#library(DT)
#df_QA <- read.table("./QualityAssessment.csv", header=TRUE, sep="\t")
#datatable(df_QA, caption = "Quality Assessment by c.ATG", extensions = c('Buttons', 'FixedColumns'), "Autofill", options = list(dom = 'Bfrtip', #scrollX = T, scrollCollapse = T, buttons = c('copy', 'csv', 'excel', 'pdf', 'print')))
```
-->

# Bioinformatics Pipeline
The Nextflow-based RNA-Seq pipeline release 1.3dev https://github.com/nf-core/rnaseq [^1] was used for the bioinfomatics analysis. Aggregation of the bioinformatics workflow analysis was conducted by `MultiQC v1.7` [^2] [@ewels2016multiqc]. `FASTQC v0.11.8` [^3] [@andrews2010fastqc] was used to determine the quality of the FASTQ files. Subsequently, adapter trimming was conducted with `Trim Galore v0.5.0` [^4] [@krueger2012trim]. `STAR v2.6.1d` [@Dobin2013] aligner was used to map the reads that passed the quality control to the mouse genome mm10 (UCSC). The evaluation of the RNA-seq experiment was performed with `RSeQC v3.0.0` [@wang2012rseqc] and read counting of the features (e.g. genes) with `featureCounts v1.6.3`[@liao2014featurecounts].
For differential expression analysis, the raw read count table resulting from `featureCounts` is processed with the R package `DESeq2 v1.22.2` [@love2014differential]. Graphs were also produced in `RStudio v1.1.456` with `R v3.5.1` using the `R` package `ggplot2 v3.1.1`<!--[@ggplot]-->. Reports were produced using the `R` package `rmarkdown v1.12` while `knitr v1.22` and `DT v0.6` were running behind the scenes. Sample similarity heatmap was created using the `edgeR v3.24.1` R package.

***

# Bioinformatics Analysis

## Metadata
A table of the combined sample preparation sheets of the two experiments is shown below:

```{r}
library(DT)
suppressMessages(library(dplyr))
df_DE <- read.table("./QPB05_QRDGM_sample_sheet.csv", header=TRUE, sep="\t")
columns <- c("QBiC.Code", "Secondary.Name", "Extract.Code.s.", "Condition..treatment")
df_DE_selected = df_DE %>% select(one_of(columns))
n_rows = nrow(df_DE_selected)
datatable(df_DE_selected, caption = "General Statistics", colnames= c("QBiC Code", "Secondary Name", "Extract Code(s)", "condition_treat"), extensions = c('Buttons', 'FixedColumns'), "Autofill", options = list(dom = 'Bfrtip', scrollX = T, scrollCollapse = T, buttons = c('copy', 'csv', 'excel', 'pdf', 'print'), pageLength = 10)) #args not working: lengthMenu = c(5, 10, 20, n_rows)))
```

## Quality Control Summary
Quality control of the data was performed using *FASTQC*. Details on the quality control parameters are available in the `MultiQC` report of all samples available [here](./results/MultiQC/multiqc_report.html). `FASTQC` reports for individual samples are additionally available [here](./results/fastqc/zips).
The table below (extracted from the `MultiQC` report) shows a summary of the bioinformatics analysis quality control including the percentage and number of assigned reads (% Assigned, M Assigned), the percentage of aligned reads (% Aligned), trimmed reads (% Trimmed), and duplicate reads (% Dups). The mean GC content (%GC) for each of the sequences and total number of reads (Seqs) is additionally indicated.

```{r include=FALSE}
# loading this library produces an output, exlude with include=FALSE
library(tidyverse)
```

```{r}
library(DT)
df_DE <- read.table("./results/MultiQC/multiqc_data/multiqc_general_stats.txt", header=TRUE, sep="\t")
columns <- c("Sample", "featureCounts_mqc.generalstats.featurecounts.percent_assigned", "featureCounts_mqc.generalstats.featurecounts.Assigned",
             "STAR_mqc.generalstats.star.uniquely_mapped_percent", "Cutadapt_mqc.generalstats.cutadapt.percent_trimmed", 
             "FastQC_mqc.generalstats.fastqc.percent_duplicates", "FastQC_mqc.generalstats.fastqc.percent_gc",
             "FastQC_mqc.generalstats.fastqc.total_sequences")
df_DE_selected = df_DE %>% select(one_of(columns))
n_rows = nrow(df_DE_selected)
datatable(df_DE_selected, caption = "General Statistics", colnames= c("Sample Name", "% Assigned", "Assigned", "% Aligned", "% Trimmed",
"% Dups", "% GC", "Seqs"), extensions = c('Buttons', 'FixedColumns'), "Autofill", options = list(dom = 'Bfrtip', scrollX = T, scrollCollapse = T, buttons = c('copy', 'csv', 'excel', 'pdf', 'print'), pageLength = 10)) #args not working: lengthMenu = c(5, 10, 20, n_rows)))
```

## Mapping Statistics

The alignment scores for each sample (first in number of reads and secondly in percentages) are shown below.

### Generalities about the mapping rates

The mapping rate of data originating from the sequencing machine depends on several factors:

* The error rate of an Illumina sequencing machine is ~0.1%.
* The error rate for sequencing of GC rich regions is higher.
* Sequencing devices are not able to sequence highly repetitive regions.
* Low quality of sequencing data results in a low mapping rate.
* There is no perfect algorithm to align the reads to a reference genome.
* There is no perfect transcript annotation of the reference genome.

<center>
```{r, echo=F, out.width="160%", dpi=1800, fig.align='center'}
knitr::include_graphics("./results/MultiQC/multiqc_plots/star_alignment_plot.svg")
```
\
```{r, echo=F, out.width="160%", dpi=1200, fig.align='center'}
knitr::include_graphics("./results/MultiQC/multiqc_plots/star_alignment_plot_pc.svg")
```
</center>


The range of mapping rate for uniquely mapped reads is > 77%.

## Read Distribution
The read distribution, in percentages, of mapped reads over different genome feature (like CDS exon, 5'UTR exon, 3' UTR exon, Intron, Intergenic regions) is shown below. The majority of the reads is assigned to CDS exons.

<center>
```{r, echo=F, out.width="160%", dpi=1200, fig.align='center'}
knitr::include_graphics("./results/MultiQC/multiqc_plots/rseqc_read_distribution_plot.svg")
```
</center>

## Gene Counts
The gene assignments of featureCounts (in percentages and number of reads) are shown below. Interpretation of the different assignment types:

**Unassigned_Ambiguity:** The reads could not be assigned because of its ambiguous character. This can be the case when e.g. a read maps to two different genes at the same time making it ambiguos. \
**Unassigned_MultiMapping:** The reads could not be assigned because they map to several distinct locations on the reference genome. \
**Unassigned_NoFeatures:** The reads could not be assigned because their mapping position in the reference genome is not annotated with any gene.

<center>
```{r, echo=F, out.width="160%", dpi=1200, fig.align='center'}
knitr::include_graphics("./results/MultiQC/multiqc_plots/featureCounts_assignment_plot.svg")
```
</center>

The assignment rate is > 49%.

***

# Statistical Analysis
In order to produce raw count tables using the same set of tools, we analysed all the raw data from both experiments together using the same nf-core Nextflow workflow (see MultiQC report and tool versions in there). For statistics, however, we separated the analysis by experiment (either QPB205 or QRDGM). We also removed day 3 samples from downstream statistical analysis because it was not present in both experiments.

## Raw and normalized count tables

The raw counts for all the samples, from both the experiments, are listed in a single table which can be found [here](./DESeq2/raw_counts/). The normalized count tables (produced separately for each experiment) are available [here](./DESeq2/results/tables/) (rlog_transformed.read.counts.tsv).

## Overview - First Exploration of the Data

### Principal Component Analysis (PCA) 
A PCA plot of the normalized expression values was created to visualize the overall effect of experimental variations and any batch effects among samples.

```{r, echo=F, out.width="2000px", dpi=1200, fig.cap="PCA plot for QRDGM, considering only the treatment variable (DESeq2 design: ~ condition_treat):", fig.align='center'}
knitr::include_graphics("./DESeq2/results/plots/QPB05/PCA_plot_of_distances_new.svg")
```

```{r, echo=F, out.width="2000px", dpi=1200, fig.cap="PCA plot for QPB05, considering only the treatment variable (DESeq2 design: ~ condition_treat):", fig.align='center'}
knitr::include_graphics("./DESeq2/results/plots/QRDGM/PCA_plot_of_distances_new.svg")
```

### Sample distance heatmap
A sample distance heatmap was generated from the distances of the normalized expression values for the samples. The closer the distance is to 0, the overall samples gene expression are more similar to each other.

```{r, echo=F, out.width="2000px", dpi=1200, fig.cap="", fig.align='center'}
knitr::include_graphics("./DESeq2/results/plots/QPB05/Heatmaps_of_distances.svg")
```

\

```{r, echo=F, out.width="2000px", dpi=1200, fig.cap="", fig.align='center'}
knitr::include_graphics("./DESeq2/results/plots/QRDGM/Heatmaps_of_distances.svg")
```

## Differentially Expressed Genes (DEGs)

### Lists of differentially expressed genes

The analysis of the differential gene expression was performed using `DESeq2`. Genes were considered differentially expressed genes (DEG) when the adjusted p-value was lower than 0.05 (padj < 0.05). The adjusted p-value is calculated in the `DESeq2` package with the Benjamini-Hochberg method and helps reduce the number of false postives (not real differentially expressed genes). The model design in DESeq2 took into account the treatment variable ‘condition_treat’ (levels: Dox-on and -off); the formula of the DESeq2 model was: ~condition_treat.
The lists of the differentially expressed genes (for the two experiments respectively) are shown below; The full tables, where the differentially expressed genes are marked with DE in the filter1 column, can be found in the respective folders [here](./DESeq2/results/final/): final_list_DESeq2_{QPB05/QRDGM}.tsv

```{r}
library(DT)
df_DE <- read.table("./DESeq2/results/final/QPB05/DE_list_DESeq2_QPB05.tsv", header=TRUE, sep="\t")
datatable(df_DE, caption = "Table containing DE genes in QPB05", extensions = c('Buttons', 'FixedColumns'), "Autofill", options = list(dom = 'Bfrtip', scrollX = T, scrollCollapse = T, buttons = c('copy', 'csv', 'excel', 'pdf', 'print')))
```

```{r}
library(DT)
df_DE <- read.table("./DESeq2/results/final/QRDGM/DE_list_DESeq2_QRDGM.tsv", header=TRUE, sep="\t")
datatable(df_DE, caption = "Table containing DE genes in QRDGM", extensions = c('Buttons', 'FixedColumns'), "Autofill", options = list(dom = 'Bfrtip', scrollX = T, scrollCollapse = T, buttons = c('copy', 'csv', 'excel', 'pdf', 'print')))
```

Please note that the number of differentially expressed genes can be shrinked if one wishes to focus only on the genes with a very meaningful fold change.

Shown below is a Venn diagramm pointing out the number of genes that were differentially expressed in both of the experiments; the list containing these genes can be found [here](./DESeq2/results/final/DE_both.tsv).

```{r, echo=F, out.width="2000px", dpi=1200, fig.cap="", fig.align='center'}
knitr::include_graphics("./DESeq2/results/plots/venn_DE.svg")
```

### Plot normalized counts of the genes

Plots of the normalized counts were generated for a subset of 20 among the differentially expressed genes. The plots are available in the respective folder for [QPB05](./DESeq2/results/plots/QPB05/plots_candidate_genes/) and [QRDGM](./DESeq2/results/plots/QRDGM/plots_candidate_genes/).
<!-- Count normalization was performed by sequencing depth and adding a pseudocount of 1/2 to allow for log scale plotting. -->

## Gene Ontology
Gene Ontology enrichment analysis was performed using `clusterProfiler v3.10.1`; GO terms that were enriched in the experiments QPB05, QRDGM and in both of them can be found in the respective tables [here](./GO):

- GO_terms_enriched_Molecular_Function_term_QPB05.tsv
- GO_terms_enriched_Molecular_Function_term_QRDGM.tsv
- GO_terms_enriched_Molecular_Function_term_DE_both.tsv

The corresponding plots are shown below and can be found in the same folder:
<center>
```{r, echo=F, out.width="2000px", dpi=1200, fig.cap="GO terms enriched in experiment QPB05", fig.align='center'}
knitr::include_graphics("./GO/GO_terms_enriched_QPB05_dotplot.png")
```

```{r, echo=F, out.width="2000px", dpi=1200, fig.cap="GO terms enriched in experiment QRDGM", fig.align='center'}
knitr::include_graphics("./GO/GO_terms_enriched_QRDGM_dotplot.png")
```

```{r, echo=F, out.width="2000px", dpi=1200, fig.cap="GO terms enriched in both the experiments", fig.align='center'}
knitr::include_graphics("./GO/GO_terms_enriched_DE_both_dotplot.png")
```
</center>

## KEGG pathway analysis
Enriched KEGG pathways of interest were found using a pathway analysis with `clusterProfiler`.
A list of the pathways enriched in each experiment, respectively, can be found [here](./KEGG/): kegg_enriched_pathways_{QPB05,QRDGM}.tsv. The plots of the KEGG pathways that were enriched can be found in the respective folders [here](./KEGG/pathway_plots); Showed are only the pathways of choice (see the [complete list](./KEGG/pathways_list.txt)). In the pathways, red corresponds to upregulated and green to downregulated parts of the pathways. There hardly is a difference in colour intensity between ~ 0.5 and 2.5 fold change.

<!--
***
# Outlook

It was possible to fulfill the analysis.



***
-->
# Bibliography
[^1]: https://www.nextflow.io/
[^2]: http://multiqc.info/
[^3]: https://www.bioinformatics.babraham.ac.uk/projects/fastqc/
[^4]: https://www.bioinformatics.babraham.ac.uk/projects/trim_galore/
[^6]: http://smithlabresearch.org/software/preseq/
[^7]: https://ccb.jhu.edu/software/stringtie/
[^8]: http://broadinstitute.github.io/picard/